package gen

import (
	"bytes"
	"fmt"
	"go/format"
	"os"

	"golang.org/x/tools/imports"
)

// Generate generates the code into a file with the given path.
// It returns the generated code as a byte slice.
func (g *Generator) Generate(outPath string, output, dryRun bool) ([]byte, error) {
	content, err := g.generateContent()
	if err != nil {
		return nil, err
	}

	optimized, err := imports.Process(outPath, content, nil)
	if err != nil {
		if output {
			fmt.Println(string(content))
		}
		return nil, fmt.Errorf("error on optimizing imports of the generated code.\n%w", err)
	}

	formatted, err := format.Source(optimized)
	if err != nil {
		if output {
			fmt.Println(string(content))
		}
		return nil, fmt.Errorf("error on formatting the generated code.\n%w", err)
	}

	if dryRun {
		if output {
			fmt.Println(string(formatted))
		}
		return formatted, nil
	}

	err = os.WriteFile(outPath, formatted, 0644)
	if err != nil {
		return nil, fmt.Errorf("error on writing to the file.\n%w", err)
	}

	return formatted, nil
}

// generateContent generates the entire code with the given information.
func (g *Generator) generateContent() (content []byte, err error) {
	sb := bytes.Buffer{}
	sb.WriteString(fmt.Sprintf("package %s\n", g.spec.PackageName))
	if len(g.spec.Imports) > 0 {
		sb.WriteString("import (\n")
	}
	for _, imp := range g.spec.Imports {
		if imp.Name != "" {
			sb.WriteString(fmt.Sprintf("%s %s\n", imp.Name, imp.Path))

		} else {
			sb.WriteString(fmt.Sprintf("%s\n", imp.Path))
		}
	}
	if len(g.spec.Imports) > 0 {
		sb.WriteString(")\n")
	}

	for _, inf := range g.spec.Interfaces {
		for _, method := range inf.Methods {
			if method.FirstParam.IsSlice && method.FirstResult.IsSlice &&
				method.FirstParam.IsStruct && method.FirstResult.IsStruct {
				sb.WriteString(method.FormatSliceOfStruct())
			} else if method.FirstParam.IsStruct && method.FirstResult.IsStruct &&
				method.FirstParam.StructDef != nil {
				sb.WriteString(method.String())
			}
		}
	}

	buf := bytes.Buffer{}
	_, err = buf.WriteString("// Code generated by github.com/structcopy/structcopy-gen. DO NOT EDIT.\n\n")
	if err == nil {
		_, err = buf.WriteString(sb.String())
	}
	if err != nil {
		return
	}

	return buf.Bytes(), nil
}
