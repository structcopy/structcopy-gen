name: CI/CD Pipeline

on:
  # 1. Trigger TEST when a Pull Request (PR) is opened, synchronized (new commit), 
  #    or reopened, targeting 'develop' or 'master'.
  pull_request:
    branches:
      - develop
      - master
    types:
      - opened
      - synchronize
      - reopened

  # 2. Trigger TEST, BUILD, and DEPLOY when a merge (which is a push) 
  #    occurs on 'develop' or 'master'.
  push:
    branches:
      - develop
      - master

permissions:
  contents: read

jobs:
  ## üß™ Test Job
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        go: [1.24]
        os: [ubuntu-latest]
    name: Run Tests
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Set up Go and Cache
        # This single step handles installing Go and automatically setting up
        # the cache for both the Go modules and the build cache.
        uses: actions/setup-go@v5 
        with:
          go-version: ${{ matrix.go }}
          
      - name: Run Tests
        # This will use the cache if available. If cache missed, it
        # automatically downloads modules and then compiles and runs tests.
        # run: go test -v ./...
        run: |
          make test
        
      # The actions/setup-go@v5 action automatically saves the Go Module 
      # and Go Build cache at the end of this job if a save is necessary.
      # This saved cache is what the next job, 'build', will restore.

  ## üèóÔ∏è Build Job
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [test] # Only runs if the 'test' job succeeded
    
    # Condition: Only run for the 'push' event (i.e., after a successful merge)
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # --- Caching the Go Environment ---
      
      - name: Set up Go
        # Only set up the environment, but don't enable caching here.
        # We will restore the cache manually below for better control.
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: false # Explicitly disable the automatic cache in this job
          
      - name: Restore Go Module Cache
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod             # Go Module Cache directory
          # The key MUST match the logic used by setup-go in the 'test' job
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
            
      # --- Build Step ---

      - name: Build Go
        # Since the Go modules are restored, this command will be faster
        # as it doesn't need to download dependencies again.
        # run: go build -o structcopy-gen ./cmd/structcopy-gen/
        run: |
          make build

      # - name: Upload Artifact
      #   # Upload the final built binary for deployment or later jobs
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: structcopy-gen-binary
      #     path: ./structcopy-gen

  # ## üöÄ Deploy Job
  # deploy:
  #   name: Deploy to Environment
  #   runs-on: ubuntu-latest
  #   needs: build # Only runs if the 'build' job succeeded
    
  #   # Condition: Only run for the 'push' event (i.e., after a successful merge)
  #   if: github.event_name == 'push'
    
  #   # Define environment based on the branch
  #   environment:
  #     # If the push is to 'develop', use the 'Development' environment.
  #     # If the push is to 'master', use the 'Production' environment.
  #     name: ${{ github.ref == 'refs/heads/develop' && 'Development' || 'Production' }}
      
  #   steps:
  #     - name: Download Artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: build-artifact
          
  #     # Example: Deployment steps (e.g., login to cloud provider and deploy)
  #     - name: Deploy to Server
  #       run: echo "Deploying to ${{ steps.set_env.outputs.env_name }} environment..."
  #       # Replace with your actual deployment steps (e.g., using a cloud-specific action)